<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Registro de Acompañamientos</title>
    <link rel="stylesheet" href="/static/css/document.css">
</head>
<body>
    <div class="container">
        <div class="header">
            <h1 style="font-size: 32px; text-align: center; color: #fff; margin: 0;">REGISTRO DE ACOMPAÑAMIENTOS</h1>
        </div>

        <!-- Lista de Seguimientos -->
        {% for seguimiento in seguimientos %}
        <div class="seguimiento">
            <h2>Seguimiento {{ seguimiento.numero }}</h2>

            <!-- Formulario principal para guardar todos los datos -->
            <form id="form-seguimiento-{{ seguimiento.numero }}" action="/save-seguimiento/{{ doc_number }}_{{ doc_adviser }}/seguimiento_{{ seguimiento.numero }}" method="post">
                <!-- Dimensiones a Intervenir -->
                <div class="filter-group">
                    <h3>Dimensiones a Intervenir</h3>
                    <div class="filter-options">
                        <div class="filter-option">
                            <input type="checkbox" id="ingresos_empleo_{{ seguimiento.numero }}" name="dimensiones" value="ingresos_empleo" {% if 'ingresos_empleo' in seguimiento.dimensiones %}checked{% endif %}>
                            <label for="ingresos_empleo_{{ seguimiento.numero }}">Ingresos y empleo</label>
                        </div>
                        <div class="filter-option">
                            <input type="checkbox" id="salud_nutricion_{{ seguimiento.numero }}" name="dimensiones" value="salud_nutricion" {% if 'salud_nutricion' in seguimiento.dimensiones %}checked{% endif %}>
                            <label for="salud_nutricion_{{ seguimiento.numero }}">Salud y nutrición</label>
                        </div>
                        <div class="filter-option">
                            <input type="checkbox" id="educacion_{{ seguimiento.numero }}" name="dimensiones" value="educacion" {% if 'educacion' in seguimiento.dimensiones %}checked{% endif %}>
                            <label for="educacion_{{ seguimiento.numero }}">Educación</label>
                        </div>
                        <div class="filter-option">
                            <input type="checkbox" id="vivienda_digna_{{ seguimiento.numero }}" name="dimensiones" value="vivienda_digna" {% if 'vivienda_digna' in seguimiento.dimensiones %}checked{% endif %}>
                            <label for="vivienda_digna_{{ seguimiento.numero }}">Vivienda digna</label>
                        </div>
                        <div class="filter-option">
                            <input type="checkbox" id="acceso_justicia_{{ seguimiento.numero }}" name="dimensiones" value="acceso_justicia" {% if 'acceso_justicia' in seguimiento.dimensiones %}checked{% endif %}>
                            <label for="acceso_justicia_{{ seguimiento.numero }}">Acceso a la justicia</label>
                        </div>
                        <div class="filter-option">
                            <input type="checkbox" id="dinamica_familiar_{{ seguimiento.numero }}" name="dimensiones" value="dinamica_familiar" {% if 'dinamica_familiar' in seguimiento.dimensiones %}checked{% endif %}>
                            <label for="dinamica_familiar_{{ seguimiento.numero }}">Dinámica familiar</label>
                        </div>
                    </div>
                </div>

                <!-- Campos del formulario -->
                <div class="form-row">
                    <div class="form-group">
                        <label for="fecha_{{ seguimiento.numero }}">Fecha</label>
                        <input type="date" id="fecha_{{ seguimiento.numero }}" name="fecha" value="{{ seguimiento.fecha }}" required>
                    </div>
                    <div class="form-group">
                        <label for="hora_{{ seguimiento.numero }}">Hora</label>
                        <input type="time" id="hora_{{ seguimiento.numero }}" name="hora" value="{{ seguimiento.hora }}" required>
                    </div>
                </div>

                <div class="form-group">
                    <label for="objetivo_{{ seguimiento.numero }}">Objetivo del acompañamiento</label>
                    <textarea id="objetivo_{{ seguimiento.numero }}" name="objetivo" required>{{ seguimiento.objetivo }}</textarea>
                </div>

                <div class="form-group">
                    <label for="aspectos_{{ seguimiento.numero }}">Principales aspectos abordados</label>
                    <textarea id="aspectos_{{ seguimiento.numero }}" name="aspectos_abordados" required>{{ seguimiento.aspectos }}</textarea>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="avances_{{ seguimiento.numero }}">Avances evidenciados</label>
                        <textarea id="avances_{{ seguimiento.numero }}" name="avances" required>{{ seguimiento.avances }}</textarea>
                    </div>
                    <div class="form-group">
                        <label for="retos_{{ seguimiento.numero }}">Retos por superar</label>
                        <textarea id="retos_{{ seguimiento.numero }}" name="retos" required>{{ seguimiento.retos }}</textarea>
                    </div>
                </div>

                <div class="form-group">
                    <label for="oportunidades_{{ seguimiento.numero }}">Desarrollo o ampliación de oportunidades</label>
                    <textarea id="oportunidades_{{ seguimiento.numero }}" name="oportunidades" required>{{ seguimiento.oportunidades }}</textarea>
                </div>

                <!-- Compromisos -->
                <div class="form-group">
                    <label>Compromisos</label>
                    <div id="compromisos_{{ seguimiento.numero }}">
                        {% for compromiso in seguimiento.compromisos %}
                        <div class="compromiso-row">
                            <input type="text" name="compromisos_desc" placeholder="Compromiso" value="{{ compromiso.descripcion }}">
                            <input type="text" name="compromisos_resp" placeholder="Responsable" value="{{ compromiso.responsable }}">
                            <input type="date" name="compromisos_fecha" value="{{ compromiso.fecha }}">
                            <button type="button" class="btn btn-secondary" onclick="this.parentNode.remove()">Eliminar</button>
                        </div>
                        {% endfor %}
                    </div>
                    <button type="button" class="btn btn-primary" onclick="agregarCompromiso('compromisos_{{ seguimiento.numero }}')">Añadir compromiso</button>
                </div>

                <!-- Participantes -->
                <div class="form-group">
                    <label>Participantes de la familia</label>
                    <div id="participantes_{{ seguimiento.numero }}">
                        {% for participante in seguimiento.participantes %}
                        <div class="participante-row">
                            <input type="text" name="participantes_nombre" placeholder="Nombre" value="{{ participante.nombre }}">
                            <input type="text" name="participantes_rol" placeholder="Rol" value="{{ participante.rol }}">
                            <input type="text" name="participantes_firma" placeholder="Firma" value="{{ participante.firma }}">
                            <button type="button" class="btn btn-secondary" onclick="this.parentNode.remove()">Eliminar</button>
                        </div>
                        {% endfor %}
                    </div>
                    <button type="button" class="btn btn-primary" onclick="agregarParticipante('participantes_{{ seguimiento.numero }}')">Añadir participante</button>
                </div>

                <!-- Imágenes -->
                <div class="form-group">
                    <h3>Imágenes del seguimiento</h3>
                    <div class="imagenes">
                        {% for img in seguimiento.imagenes %}
                        <img src="/image/{{ doc_number }}/{{ seguimiento.numero }}/{{ img }}" alt="Imagen del seguimiento">
                        {% endfor %}
                    </div>
                    
                </div>

                <!-- Botón para guardar el seguimiento -->
                <div class="form-group" style="text-align: center; margin-top: 30px;">
                    <!-- Botón de guardar - actualizado -->
                    <button type="submit" class="btn btn-primary" id="guardarBtn">
                        <span id="submitText">Guardar Seguimiento</span>
                    </button>
                    <!-- <button type="button" class="btn btn-export" onclick="exportToPDF('{{ doc_number }}', 'seguimiento_{{ seguimiento.numero }}')">Generar Informe</button> -->
                    <button type="button" class="btn btn-export" onclick="exportToPDF(this)">Generar Informe</button>
                </div>

            </form>
            <form action="/upload-file/{{ doc_number }}/{{ seguimiento.numero }}" method="post" enctype="multipart/form-data">
                        <input type="file" name="files" multiple>
                        <button type="submit" class="btn btn-primary">Subir imágenes</button>
            </form>
        </div>
        {% endfor %}
    </div>
    <script src="/static/js/html2pdf.bundle.min.js"></script>
    <script>
        // Función para agregar un nuevo compromiso
        function agregarCompromiso(containerId) {
            const container = document.getElementById(containerId);
            if (!container) return;

            const newRow = document.createElement('div');
            newRow.className = 'compromiso-row';
            newRow.innerHTML = `
                <input type="text" name="compromisos_desc" placeholder="Compromiso">
                <input type="text" name="compromisos_resp" placeholder="Responsable">
                <input type="date" name="compromisos_fecha">
                <button type="button" class="btn btn-secondary" onclick="this.parentNode.remove()">Eliminar</button>
            `;
            container.appendChild(newRow);
        }

        // Función para agregar un nuevo participante
        function agregarParticipante(containerId) {
            const container = document.getElementById(containerId);
            if (!container) return;

            const newRow = document.createElement('div');
            newRow.className = 'participante-row';
            newRow.innerHTML = `
                <input type="text" name="participantes_nombre" placeholder="Nombre">
                <input type="text" name="participantes_rol" placeholder="Rol">
                <input type="text" name="participantes_firma" placeholder="Firma">
                <button type="button" class="btn btn-secondary" onclick="this.parentNode.remove()">Eliminar</button>
            `;
            container.appendChild(newRow);
        }
       async function exportToPDF(button) {
            try {
                console.log('Iniciando generación de PDF...');
                
                // 1. Obtener el elemento a convertir
                const seguimientoDiv = button.closest('.seguimiento');
                if (!seguimientoDiv) {
                    console.error('No se encontró el div de seguimiento');
                    return;
                }

                // 2. Clonar el elemento
                const element = seguimientoDiv.cloneNode(true);
                console.log('Elemento clonado:', element);

                // 3. Preparar el contenido para PDF
                prepareForPDF(element);
                console.log('Contenido preparado para PDF');

                // 4. Configuración de html2pdf
                const opt = {
                    margin: 10,
                    filename: `Seguimiento_${seguimientoDiv.querySelector('h2').textContent.trim().replace('Seguimiento ', '')}.pdf`,
                    image: { type: 'jpeg', quality: 0.98 },
                    html2canvas: { 
                        scale: 2,
                        scrollY: 0,
                        windowWidth: 1200,
                        width: 1200,
                        logging: true,
                        useCORS: true
                    },
                    jsPDF: { 
                        unit: 'mm', 
                        format: 'a4', 
                        orientation: 'portrait' 
                    }
                };
                console.log('Opciones configuradas:', opt);

                // 5. Crear contenedor temporal
                const tempContainer = document.createElement('div');
                tempContainer.style.position = 'fixed';
                tempContainer.style.left = '-9999px';
                tempContainer.style.width = '800px';
                tempContainer.appendChild(element);
                document.body.appendChild(tempContainer);
                console.log('Contenedor temporal creado');

                // 6. Generar PDF
                console.log('Iniciando generación del PDF...');
                await html2pdf().set(opt).from(element).save();
                console.log('PDF generado con éxito');

                // 7. Limpiar
                document.body.removeChild(tempContainer);
                console.log('Contenedor temporal eliminado');
                
            } catch (error) {
                console.error('Error al generar PDF:', error);
                alert('Ocurrió un error al generar el PDF. Por favor verifica la consola para más detalles.');
            }
        }

        function prepareForPDF(element) {
            // Asegurar que el elemento sea visible para html2canvas
            element.style.opacity = '1';
            element.style.visibility = 'visible';
            element.style.display = 'block';
            element.style.width = '100%';
            element.style.padding = '20px';
            element.style.boxSizing = 'border-box';
            element.style.backgroundColor = '#fff';

            // Ocultar elementos no deseados
            element.querySelectorAll('button, input[type="file"]').forEach(el => el.remove());

            // Procesar checkboxes de dimensiones
            const dimensionesContainer = element.querySelector('.filter-options');
            if (dimensionesContainer) {
                let html = '<ul style="list-style-type: none; padding-left: 0; margin: 10px 0;">';
                dimensionesContainer.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                    if (checkbox.checked) {
                        const label = checkbox.nextElementSibling.textContent.trim();
                        html += `<li>✓ ${label}</li>`;
                    }
                });
                html += '</ul>';
                dimensionesContainer.innerHTML = html;
            }

            // Convertir inputs a texto
            element.querySelectorAll('input:not([type="checkbox"]), textarea').forEach(input => {
                const span = document.createElement('span');
                span.textContent = input.value || '';
                span.style.display = 'inline-block';
                span.style.margin = '2px 0';
                span.style.padding = '2px 5px';
                span.style.width = '100%';
                input.parentNode.replaceChild(span, input);
            });

            // Ajustar estilos de compromisos y participantes
            element.querySelectorAll('.compromiso-row, .participante-row').forEach(row => {
                row.style.display = 'flex';
                row.style.flexWrap = 'wrap';
                row.style.gap = '10px';
                row.style.marginBottom = '10px';
            });
        }

        // Validación antes de enviar el formulario
        document.querySelectorAll('form[id^="form-seguimiento-"]').forEach(form => {
            form.addEventListener('submit', function(e) {
                // Validar que al menos una dimensión esté seleccionada
                const checkboxes = this.querySelectorAll('input[name="dimensiones"]:checked');
                if (checkboxes.length === 0) {
                    alert('Por favor seleccione al menos una dimensión a intervenir');
                    e.preventDefault();
                    return false;
                }
                return true;
            });
        });
    </script>
</body>
</html>